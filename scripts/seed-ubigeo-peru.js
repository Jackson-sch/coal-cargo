const { prisma } = require("../src/lib/prisma-cjs"); const https = require("https"); async function fetchUbigeoData() { return new Promise((resolve, reject) => { console.log("ğŸ“¡ Descargando datos de ubigeo desde la API..."); https .get("https://free.e-api.net.pe/ubigeos.json", (res) => { let data = ""; res.on("data", (chunk) => { data += chunk; }); res.on("end", () => { try { const jsonData = JSON.parse(data); console.log("âœ… Datos de ubigeo descargados exitosamente"); resolve(jsonData); } catch (error) { console.error("âŒ Error al parsear los datos JSON:", error.message); reject(error); }
        }); }) .on("error", (error) => { console.error("âŒ Error al descargar datos de ubigeo:", error.message); reject(error); }); }); }

async function seedUbigeoPeru() { try { console.log("ğŸ‡µğŸ‡ª Procesando datos de ubigeo del PerÃº..."); let ubigeoData; try { ubigeoData = await fetchUbigeoData(); } catch (error) { console.log( "âš ï¸ No se pudieron descargar los datos de la API. Creando datos bÃ¡sicos de ubigeo..." ); await seedUbigeoBasico(); return; }

    const departamentos = []; const provincias = []; const distritos = []; // Procesar la estructura anidada Object.keys(ubigeoData).forEach((departamentoNombre) => { const departamentoData = ubigeoData[departamentoNombre]; // Obtener el primer distrito para extraer el cÃ³digo del departamento const primerProvincia = Object.values(departamentoData)[0]; const primerDistrito = Object.values(primerProvincia)[0]; const codigoDepartamento = primerDistrito.ubigeo.substring(0, 2); // Agregar departamento const departamento = { id: `dep-${codigoDepartamento}`, nombre: departamentoNombre, codigo: codigoDepartamento, }; departamentos.push(departamento); // Procesar provincias Object.keys(departamentoData).forEach((provinciaNombre) => { const provinciaData = departamentoData[provinciaNombre]; // Obtener el primer distrito para extraer el cÃ³digo de la provincia const primerDistritoProv = Object.values(provinciaData)[0]; const codigoProvincia = primerDistritoProv.ubigeo.substring(0, 4); // Agregar provincia const provincia = { id: `prov-${codigoProvincia}`, nombre: provinciaNombre, codigo: codigoProvincia, departamentoId: `dep-${codigoDepartamento}`, }; provincias.push(provincia); // Procesar distritos Object.keys(provinciaData).forEach((distritoNombre) => { const distritoData = provinciaData[distritoNombre]; const distrito = { id: `dist-${distritoData.ubigeo}`, nombre: distritoNombre, codigo: distritoData.ubigeo, provinciaId: `prov-${codigoProvincia}`, }; distritos.push(distrito); }); }); }); console.log(`ğŸ“‹ Procesados:`); console.log(` ğŸ›ï¸ ${departamentos.length} departamentos`); console.log(` ğŸ˜ï¸ ${provincias.length} provincias`); console.log(` ğŸ  ${distritos.length} distritos`); // Limpiar datos existentes console.log("ğŸ§¹ Limpiando datos existentes..."); await prisma.ubigeo_distritos.deleteMany(); await prisma.ubigeo_provincias.deleteMany(); await prisma.ubigeo_departamentos.deleteMany(); // Insertar departamentos console.log("ğŸ›ï¸ Insertando departamentos..."); for (const dept of departamentos) { await prisma.ubigeo_departamentos.create({ data: dept, }); }

    // Insertar provincias console.log("ğŸ˜ï¸ Insertando provincias..."); for (const prov of provincias) { await prisma.ubigeo_provincias.create({ data: prov, }); }

    // Insertar distritos en lotes para mejor rendimiento console.log("ğŸ  Insertando distritos..."); const batchSize = 100; for (let i = 0; i < distritos.length; i += batchSize) { const batch = distritos.slice(i, i + batchSize); await prisma.ubigeo_distritos.createMany({ data: batch, }); console.log( `  ğŸ“¦ Insertados ${Math.min(i + batchSize, distritos.length)} de ${ distritos.length } distritos` ); }

    // Verificar inserciÃ³n const totalDepartamentos = await prisma.ubigeo_departamentos.count(); const totalProvincias = await prisma.ubigeo_provincias.count(); const totalDistritos = await prisma.ubigeo_distritos.count(); console.log("âœ… Datos insertados exitosamente:"); console.log(` ğŸ›ï¸ ${totalDepartamentos} departamentos`); console.log(` ğŸ˜ï¸ ${totalProvincias} provincias`); console.log(` ğŸ  ${totalDistritos} distritos`); // Mostrar algunos ejemplos console.log("\nğŸ“‹ Ejemplos de departamentos:"); const ejemploDepartamentos = await prisma.ubigeo_departamentos.findMany({ take: 5, orderBy: { nombre: "asc" }, }); ejemploDepartamentos.forEach((dept) => { console.log(` â€¢ ${dept.nombre} (${dept.codigo})`); }); console.log("\nğŸ“‹ Ejemplos de Lima:"); const lima = await prisma.ubigeo_departamentos.findFirst({ where: { nombre: "LIMA" }, include: { provincias: { take: 3, include: { distritos: { take: 3, }, }, }, }, }); if (lima) { console.log(` ğŸ›ï¸ ${lima.nombre}:`); lima.provincias.forEach((prov) => { console.log(` ğŸ˜ï¸ ${prov.nombre}:`); prov.distritos.forEach((dist) => { console.log(` ğŸ  ${dist.nombre} (${dist.codigo})`); }); }); }

    console.log("ğŸ‰ Ubigeo del PerÃº cargado exitosamente"); } catch (error) { console.error("ğŸ’¥ Error cargando ubigeo:", error); throw error; }
} // FunciÃ³n para crear datos bÃ¡sicos de ubigeo cuando no se encuentra el archivo JSON async function seedUbigeoBasico() { console.log("ğŸ—ºï¸ Creando ubigeo bÃ¡sico..."); // Crear departamentos bÃ¡sicos const departamentos = [ { id: "dep-15", nombre: "Lima", codigo: "15" }, { id: "dep-04", nombre: "Arequipa", codigo: "04" }, { id: "dep-08", nombre: "Cusco", codigo: "08" }, { id: "dep-13", nombre: "La Libertad", codigo: "13" }, { id: "dep-20", nombre: "Piura", codigo: "20" }, ]; for (const dept of departamentos) { const existing = await prisma.ubigeo_departamentos.findUnique({ where: { id: dept.id }, }); if (!existing) { await prisma.ubigeo_departamentos.create({ data: dept }); console.log(`âœ… Departamento creado: ${dept.nombre}`); }
  } // Crear provincias bÃ¡sicas const provincias = [ {
      id: "prov-1501", nombre: "Lima", codigo: "1501", departamentoId: "dep-15", }, {
      id: "prov-0401", nombre: "Arequipa", codigo: "0401", departamentoId: "dep-04", }, {
      id: "prov-0801", nombre: "Cusco", codigo: "0801", departamentoId: "dep-08", }, {
      id: "prov-1301", nombre: "Trujillo", codigo: "1301", departamentoId: "dep-13", }, {
      id: "prov-2001", nombre: "Piura", codigo: "2001", departamentoId: "dep-20", }, ]; for (const prov of provincias) { const existing = await prisma.ubigeo_provincias.findUnique({ where: { id: prov.id }, }); if (!existing) { await prisma.ubigeo_provincias.create({ data: prov }); console.log(`âœ… Provincia creada: ${prov.nombre}`); }
  } // Crear distritos bÃ¡sicos const distritos = [ {
      id: "dist-150101", nombre: "Lima", codigo: "150101", provinciaId: "prov-1501", }, {
      id: "dist-040101", nombre: "Arequipa", codigo: "040101", provinciaId: "prov-0401", }, {
      id: "dist-080101", nombre: "Cusco", codigo: "080101", provinciaId: "prov-0801", }, {
      id: "dist-130101", nombre: "Trujillo", codigo: "130101", provinciaId: "prov-1301", }, {
      id: "dist-200101", nombre: "Piura", codigo: "200101", provinciaId: "prov-2001", }, ]; for (const dist of distritos) { const existing = await prisma.ubigeo_distritos.findUnique({ where: { id: dist.id }, }); if (!existing) { await prisma.ubigeo_distritos.create({ data: dist }); console.log(`âœ… Distrito creado: ${dist.nombre}`); }
  } console.log("âœ… Ubigeo bÃ¡sico creado exitosamente"); }

module.exports = seedUbigeoPeru; // Si se ejecuta directamente if (require.main === module) { seedUbigeoPeru() .then(() => { console.log("âœ… Proceso completado"); process.exit(0); }) .catch((error) => { console.error("âŒ Error:", error); process.exit(1); }) .finally(() => { prisma.$disconnect(); }); }
